#!/usr/bin/env bash
VAR_DIRS="var/cache var/logs var/www/static var/www/media/uploads"
DEPLOYED="var/.deployed"
ENV_FILE=".env"
ACTIONS=("run" "run-dev" "update" "install")

cd $(dirname $(dirname $(readlink -f "$0")))  # Change to ..
set -o allexport; [[ -f "$ENV_FILE" ]] && . "$ENV_FILE"; set +o allexport

_has_command(){ command -v "$1" 2>&1 >/dev/null; }

_permissions(){
  sudo chown -R www-data:ubuntu var
  sudo chmod -R u=rwX,g=rwsX,o= var
}

_venv(){
  python3 -mvenv venv
  [[ -f backend/local.requirements.txt ]] && venv/bin/pip install --upgrade -r backend/local.requirements.txt
  [[ -f backend/requirements.txt ]] && venv/bin/pip install --upgrade -r backend/requirements.txt
  echo "$(pwd)/backend/src/" > venv/lib/python3.5/site-packages/backend.pth
}

_restart(){
  sudo systemctl restart production_gunicorn
  sudo systemctl restart production_celery
}

install(){
  [[ -z "$1" ]] && echo "No repository specified" && exit 1
  git clone --recursive "$1" backend
  update
}

update(){
  mkdir -p $VAR_DIRS
  _has_command sudo && _permissions
  git pull && git submodule update
  git -C backend pull && git -C backend submodule update
  if [[ -d "frontend" ]]; then
    git -C frontend pull && git -C frontend submodule update
    _has_command npm && npm --prefix frontend run build
  fi
  _venv
  . ./venv/bin/activate
  django-admin collectstatic --noinput
  django-admin migrate --noinput
  _has_command systemctl && _restart
  touch "$DEPLOYED"
}

run(){
  [[ -f "$DEPLOYED" ]] || update
  . ./venv/bin/activate
  $1 ${@:2}
}

run-dev(){ run django-admin runserver_plus --nopin --pm 0.0.0.0:8000; }

set -x
for action in "${ACTIONS[@]}"; do
	[[ "$action" == "$1" ]] && { $1 "${@:2}"; exit 0; }
done
echo "Invalid action specified: $1" && exit 1
